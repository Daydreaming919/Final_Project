---
title: "The Longitudinal Impact of Public Education Expenditure on Student Academic Performance"
author: "Hao Xu"
format: 
  pdf:
    filters:
    - wordcount
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r}
# libraries used in the following codes will be all written in this part
library(tidyverse)
library(ggthemes)
library(ggplot2)
library(dplyr)
library(tidyr)
library(here)
library(knitr)
library(kableExtra)
library(ggrepel)
library(scales)
library(cluster)
library(factoextra) 
library(quantreg)
library(lmtest)
library(sandwich)
library(broom)
```

```{r}
here::i_am("Final_Project.Rproj")
```

## Research Question

Education is widely regarded as the cornerstone of human capital and national development. Consequently, governments around the world invest a significant portion of their GDP into public education. However, a fundamental question remains in education economics: Does spending more money actually lead to better student performance? This relationship is quite controversial remains debated.

By using PISA data with macroeconomic indicators from the World Bank, this project aims to provide a comparative analysis of how public education expenditure impacts student academic performance using empirical data.

Firstly, this project tries to find whether public education actually lead to better student performance. More specifically, I want to find the possible heterogeneity of this impact, including the effectiveness of public spending according to a country's economic development level. In other words, the expenditure of developing countries and developed countries may have different outcomes, due to the achievements they have already realized. We anticipate that education expenditure will have a significant positive impact, while the impact of additional spending on average scores to be weaker or insignificant for developed countries due to the possible diminishing marginal returns of public expenditure.

Furthermore, instead of just focusing at overall scores, this project tries to analyzes how public education expenditure affects students' performance in other specific ways. For example, does spending reduce the performance gap between students within a country? Does it improve overall results by helping struggling students catch up, or by creating more top students? The project also examines whether increased expenditure could narrow the gender achievement gap in specific subjects, which illustrates the possibility of public investment to promote gender equality in educational outcomes. These questions aim to explore whether public education expenditure makes education fairer. By unpacking the PISA data, we can understand more deeply how education spending works.

## Data Description

### Data Sources

The data used in this project comes from two sources. One is the Official website of PISA, the other is World Bank data bank.

#### PISA

Data Link: <https://webfs.oecd.org/pisa2022/index.html>

The full name of PISA is **Programme for International Student Assessment**. It is a survey conducted by the OECD, designed to evaluate education systems worldwide by testing the skills and knowledge of 15-year-old students. This data set provides detailed micro data on student performance in reading, mathematics, and science, alongside extensive background information from student, parent, school, and teacher questionnaires. What I used in this project are the results of student questionnaires. You can access to the data through the link provided below. However, PISA only provided files in formats used for SPSS and SAS, the files that can be used for R are provided in the dropbox of my repository.

#### World Bank

Data Link: <https://databank.worldbank.org/source/world-development-indicators/>

Other variables I used as key variable and control variables come from world bank. You can access to the raw data using the link given below.

If you want to reproduce the data selection process, instructions are following: Use the link given below, specify "All" countries and the time range from 2000 to 2024, and then select the following series indicators (see in the block).Finally, download the resulting data set for analysis. The data file can also be found in my repository.

> (1) IT.NET.USER.ZS (Individuals using the Internet (% of population))
> (2) SP.URB.TOTL.IN.ZS (Urban population (% of total))
> (3) SI.POV.GINI (GINI index (World Bank estimate))
> (4) NY.GDP.PCAP.PP.KD (GDP per capita, PPP (current international \$))(4)
> (5) SE.PRE.ENRR (School enrollment, preprimary (% gross)),SE.PRE.ENRR.FE (School enrollment, preprimary, female (% gross)),SE.PRE.ENRR.MA (School enrollment, preprimary, male (% gross))
> (6) SE.COM.DURS (Compulsory education, duration (years)),
> (7) SE.XPD.CTOT.ZS (Current education expenditure, total (% of total government expenditure)) (8) SE.XPD.TOTL.GD.ZS (Expenditure on education (% of GDP))
> (8) GE.EST (Government Effectiveness Estimate)

### Data Cleaning Process

Because the cleaning process is quite complicated, the code is not included in this document. If you need to know the detailed data cleaning process and its codes, please refer to the **Data_Clean.qmd** document. To reproduce the results, you will need to download the Pisa_Raw data from my GitHub into your data folder. Below is a brief description of the steps I took.

The data provided by PISA is quite complex. To make it more suitable for my project, I have done a series of data cleaning steps.

For the data before 2012, PISA only provided code files of SPSS and the data in TXT format. Therefore, I calculated the data from 2003 to 2012 through SPSS by following the official PISA instructions and codes. However, the Pisa 2000 was not included in my project because its format is quite different from the later data (the three subjects: reading, math and science were split into three separate files), which makes it more difficult to use. This resulted in all data being in SAV format. (The raw data can be downloaded via the Dropbox link provided on my GitHub.) I used read_sav to import all data into RStudio and saved it in CSV format for further processing.

Pisa Data is very heavy. For example, the Pisa 2022 student data contains 613,744 observations and 1,278 variables. Therefore, I first have done a basic cleaning on the 2003-2022 data. I referred to the learningtower cleaned the Pisa data to choose these important columns, but not all of these columns will necessarily be used in later research.

Next, because the Pisa data is at the individual level, while my research is at the country level, I have aggregated the Pisa data. I grouped the data by country for each year and used the student weights provided in the Pisa data set to summarize the students' reading, math, and science scores, along with the other necessary variables.

Then, I matched this aggregated data with other country-level macroeconomic data provided by the World Bank.

### Data Representation

#### Basic Information

```{r}

pisa_all <- read_csv(here("Data", "pisa_all.csv"), show_col_types = FALSE) 
pisa_agg <- read_csv(here("Data", "pisa_aggregated.csv"), show_col_types = FALSE)
wb   <- read_csv(here("Data", "WorldBank.csv"), show_col_types = FALSE)
final_dataset <- read_csv(here("Data", "final_dataset.csv"), show_col_types = FALSE)

get_data_info <- function(df, file_name) {
  tibble(
    Dataset = file_name,
    Observations = nrow(df),
    Variables = ncol(df),
    `Total Missing Values` = sum(is.na(df)),
    `Rows with Missing` = sum(!complete.cases(df))
  )
}

summary_table <- bind_rows(
  get_data_info(pisa_all, "pisa_all"),
  get_data_info(pisa_agg, "pisa_aggregated"),
  get_data_info(wb, "WorldBank"),
  get_data_info(final_dataset, "final_dataset")
)

kable(summary_table, caption = "Table 1: Basic Information") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
```

##### Description of Key Variables

The Key variables of this project are mainly contained in the final_dataset.csv, following are the short descriptions of them.

**math/read/science_mean**: The weighted average PISA scores for Mathematics, Reading, and Science, representing the overall academic performance of a country.

**math/read/science_sd**: The standard deviation of scores within each domain. A higher SD indicates a wider gap between students in this country.

**math/read/science_low_achievers(top_performers)**: The proportion of students scoring below Level 2 (struggling students) and above Level 5 (elite students), respectively.

**math/read/science_female(male)**: The mean scores aggregated for each gender.

**escs_mean**: The PISA Index of economic, social, and cultural Status, capturing students' family background (parents' education, occupation, and home possessions).

**gdp_ppp**: GDP per capita based on purchasing power parity (constant 2021 international \$)

**edu_exp**: Government expenditure on education as a percentage of GDP.

**edu_exp_capita**: : Calculated by multiplying gdp_ppp by edu_exp, to illustrate the country's total education expenditure per capita.

**current_exp_pct**: Current education expenditure as a share of total spending.

**gov_effect**: An indicator of Government Effectiveness, measuring the quality of public services and policy implementation.

**gini**: The Gini Index, measuring income inequality to control for broader social stratification.

**comp_edu_years**: The duration of compulsory education in years.

**pre_primary_total/female/male**: Gross enrollment ratios in pre-primary education, used to control for early childhood investment.

**internet**: The percentage of individuals using the Internet.

**urban_pop**: The percentage of the population living in urban areas.


## Data Analysis


After obtaining the data, this project analyzes the data from several aspects. First, I use charts to show some basic facts of the data. This includes how country rankings evolved over the last 10 years and how PISA scores are distributed. I also use scatter plots to show the correlation between education expenditure and student performance. Based on the research hypotheses, I distinguish between economic development levels to compare the differences in this relationshp.

Then, I employ regression models to examine the specific impact of education expenditure on PISA scores. A quadratic term is introduced to test the hypothesis of diminishing marginal effects of education expenditure. Additionally, I use robust standard errors clustered by country to enhance the robustness of the models.

Next, I analyze the heterogeneity of the impact of education expenditure. Based on subgroup analysis, we found that the effect of education expenditure is more significant in low and middle income countries. Based on this outcome, I further compare the heterogeneous effects on students with different performance levels using quantile regression and different genders within both income groups.

Finally, I use the K-means clustering algorithm to classify sample countries education expenditure, academic performance, and economic level. This was done to identify and summarize different types of educational input-output patterns.

### Basic Information Presentation

In this section, I use Bump Charts to show how the rankings of these three subjects have evolved from 2003 to 2022. Since PISA covers a large number of countries countries, I only focus on the top 20 countries and highlight the top 10 according to the rankings of 2022 to make the graph easier to read.

```{r}
pisa_long <- final_dataset %>%
  select(iso3c, year, math_mean, read_mean, science_mean) %>%
  pivot_longer(
    cols = c(math_mean, read_mean, science_mean),
    names_to = "subject",
    values_to = "score"
  ) %>%
  mutate(
    subject = case_when(
      subject == "math_mean" ~ "Mathematics",
      subject == "read_mean" ~ "Reading",
      subject == "science_mean" ~ "Science"
    ),
    year = as.integer(year)
  )
```

```{r}
math_ranks <- pisa_long %>%
  filter(subject == "Mathematics", !is.na(score)) %>%
  group_by(year) %>%
  mutate(rank = rank(-score, ties.method = "first")) %>%
  ungroup() %>%
  filter(rank <= 20)

math_top10_2022 <- math_ranks %>%
  filter(year == 2022, rank <= 10) %>%
  pull(iso3c)

ggplot(math_ranks, aes(x = year, y = rank, group = iso3c)) +
  
  geom_line(data = filter(math_ranks, !iso3c %in% math_top10_2022),
            color = "grey90", size = 0.8) +
  
  geom_line(data = filter(math_ranks, iso3c %in% math_top10_2022),
            aes(color = iso3c), size = 1.5) +
  geom_point(data = filter(math_ranks, iso3c %in% math_top10_2022),
             aes(color = iso3c), size = 3) +
  
  geom_text(data = filter(math_ranks, year == 2022, iso3c %in% math_top10_2022),
            aes(label = iso3c, color = iso3c), hjust = -0.2, fontface = "bold", size = 3.5) +
  
  scale_y_reverse(breaks = seq(1, 20, 1)) +
  scale_x_continuous(breaks = c(2003, 2006, 2009, 2012, 2015, 2018, 2022)) +
  scale_color_tableau("Tableau 20") +
  coord_cartesian(clip = "off") +
  labs(title = "Mathematics: Top 20 Rankings Evolution", 
       subtitle = "Highlighting 2022 Top 10 Performers", y = "Rank", x = NULL) +
  theme_minimal() +
  theme(legend.position = "none", plot.title = element_text(face="bold"),
        plot.margin = margin(r = 30, l = 10))
```

```{r}
read_ranks <- pisa_long %>%
  filter(subject == "Reading", !is.na(score)) %>%
  group_by(year) %>%
  mutate(rank = rank(-score, ties.method = "first")) %>%
  ungroup() %>%
  filter(rank <= 20)

read_top10_2022 <- read_ranks %>%
  filter(year == 2022, rank <= 10) %>%
  pull(iso3c)

ggplot(read_ranks, aes(x = year, y = rank, group = iso3c)) +
  
  geom_line(data = filter(read_ranks, !iso3c %in% read_top10_2022),
            color = "grey90", size = 0.8) +
  
  geom_line(data = filter(read_ranks, iso3c %in% read_top10_2022),
            aes(color = iso3c), size = 1.5) +
  geom_point(data = filter(read_ranks, iso3c %in% read_top10_2022),
             aes(color = iso3c), size = 3) +
  
  geom_text(data = filter(read_ranks, year == 2022, iso3c %in% read_top10_2022),
            aes(label = iso3c, color = iso3c), hjust = -0.2, fontface = "bold", size = 3.5) +
  
  scale_y_reverse(breaks = seq(1, 20, 1)) +
  scale_x_continuous(breaks = c(2003, 2006, 2009, 2012, 2015, 2018, 2022)) +
  scale_color_tableau("Tableau 20") +
  coord_cartesian(clip = "off") +
  labs(title = "Reading: Top 20 Rankings Evolution", 
       subtitle = "Highlighting 2022 Top 10 Performers", y = "Rank", x = NULL) +
  theme_minimal() +
  theme(legend.position = "none", plot.title = element_text(face="bold"),
        plot.margin = margin(r = 30, l = 10))
```

```{r}
sci_ranks <- pisa_long %>%
  filter(subject == "Science", !is.na(score)) %>%
  group_by(year) %>%
  mutate(rank = rank(-score, ties.method = "first")) %>%
  ungroup() %>%
  filter(rank <= 20)

sci_top10_2022 <- sci_ranks %>%
  filter(year == 2022, rank <= 10) %>%
  pull(iso3c)

ggplot(sci_ranks, aes(x = year, y = rank, group = iso3c)) +
  
  geom_line(data = filter(sci_ranks, !iso3c %in% sci_top10_2022),
            color = "grey90", size = 0.8) +
  
  geom_line(data = filter(sci_ranks, iso3c %in% sci_top10_2022),
            aes(color = iso3c), size = 1.5) +
  geom_point(data = filter(sci_ranks, iso3c %in% sci_top10_2022),
             aes(color = iso3c), size = 3) +
  
  geom_text(data = filter(sci_ranks, year == 2022, iso3c %in% sci_top10_2022),
            aes(label = iso3c, color = iso3c), hjust = -0.2, fontface = "bold", size = 3.5) +
  
  scale_y_reverse(breaks = seq(1, 20, 1)) +
  scale_x_continuous(breaks = c(2003, 2006, 2009, 2012, 2015, 2018, 2022)) +
  scale_color_tableau("Tableau 20") +
  coord_cartesian(clip = "off") +
  labs(title = "Science: Top 20 Rankings Evolution", 
       subtitle = "Highlighting 2022 Top 10 Performers", y = "Rank", x = NULL) +
  theme_minimal() +
  theme(legend.position = "none", plot.title = element_text(face="bold"),
        plot.margin = margin(r = 30, l = 10))
```

The following box plot illustrates the distribution of PISA scores,  The distribution of scores across the three subjects is generally similar: the median is around 480, and the scores of all three subjects extend to roughly 600 and 300. The boxes are relatively wide, which means there exists a significant gap in PISA scores across countries in these three subjects.
```{r}

plot_data <- final_dataset %>%

  pivot_longer(
    cols = c(math_mean, read_mean, science_mean),
    names_to = "subject",
    values_to = "score"
  ) %>%

  mutate(subject = case_when(
    subject == "math_mean" ~ "Mathematics",
    subject == "read_mean" ~ "Reading",
    subject == "science_mean" ~ "Science"
  )) %>%
  
  filter(!is.na(score))
```

```{r}

ggplot(plot_data, aes(x = subject, y = score)) +

  geom_boxplot() + 
  
  facet_wrap(~subject, scales = "free") + 
  
  labs(
    title = "Distribution of PISA Scores by Subject",
    x = "Subject",
    y = "Score"
  ) +
  theme_minimal()
```

The scatter plot below illustrates the basic relationship between education expenditure and PISA scores. There are some similar and interesting patterns across the three subjects: At the stage of low expenditure, increasing spending seems to bring a significant improvement in scores. However, as the spending achieves a certain level, the score improvement becomes less obvious. This might suggest the diminishing marginal returns of public expenditure that we noted in the first part of this project. We will further explore this trend in the later phases.

```{r}
ggplot(plot_data, aes(x = edu_exp_capita, y = score)) +
  
  geom_point(alpha = 0.5) + 
  
  facet_wrap(~subject, scales = "free_y") +
  
  labs(
    title = "Expenditure per Capita vs. Scores",
    x = "Expenditure per Student",
    y = "Mean Score"
  ) +
  theme_minimal()
```
```{r}
final_dataset %>%
  
  mutate(

    edu_exp_capita = as.numeric(edu_exp_capita),
    gdp_ppp = as.numeric(gdp_ppp),
    
    Income_Group = if_else(gdp_ppp < 30000, "Low/Mid Income (<$30k)", "High Income (>=$30k)")
  ) %>%
  
  pivot_longer(
    cols = c(math_mean, read_mean, science_mean),
    names_to = "subject",
    values_to = "score"
  ) %>%
  
  mutate(
    subject = case_when(
      subject == "math_mean" ~ "Mathematics",
      subject == "read_mean" ~ "Reading",
      subject == "science_mean" ~ "Science"
    )
  ) %>%
  
  filter(!is.na(score), !is.na(edu_exp_capita)) %>%
  
  ggplot(aes(x = edu_exp_capita, y = score)) +
  
  geom_point(aes(color = Income_Group), size = 2, alpha = 0.6) +
  
  geom_smooth(method = "loess", color = "black", size = 0.8, se = TRUE, alpha = 0.2) +
  
  facet_wrap(~subject, ncol = 3) +
  
  scale_color_manual(values = c("High Income (>=$30k)" = "#E69F00", 
                                "Low/Mid Income (<$30k)" = "#56B4E9")) +
  
  labs(
    title = "Relationship between Education Expenditure and Student Performance",
    subtitle = "Scatter plot with Loess smoothing curve showing diminishing returns",
    x = "Absolute Education Expenditure per Student (PPP)",
    y = "Mean PISA Score",
    color = "Economic Status"
  ) +
  
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold", size = 14),
    strip.text = element_text(size = 12, face = "bold"),
    axis.title = element_text(size = 11)
  )
```
### Regression Outcome

```{r}
run_regression <- function(dep_var, name) {
  
  f <- as.formula(paste(dep_var, "~ edu_exp_capita + I(edu_exp_capita^2) + escs_mean + gini + internet"))
  
  model <- lm(f, data = final_dataset)
  
  broom::tidy(model) %>%
    mutate(
      Subject = name,
      stars = case_when(
        p.value < 0.01 ~ "***",
        p.value < 0.05 ~ "**",
        p.value < 0.1  ~ "*",
        TRUE ~ ""
      ),
      estimate_str = paste0(round(estimate, 3), stars),
      std.error_str = paste0("(", round(std.error, 3), ")")
    ) %>%
    select(Term = term, Estimate = estimate_str, `Std. Error` = std.error_str, Subject)
}

res_math <- run_regression("math_mean", "Mathematics")
res_read <- run_regression("read_mean", "Reading")
res_sci  <- run_regression("science_mean", "Science")

reg_results <- bind_rows(res_math, res_read, res_sci) %>%
  
  mutate(Term = case_when(
    Term == "(Intercept)" ~ "Intercept",
    Term == "edu_exp_capita" ~ "Education Exp. (Capita)",
    Term == "I(edu_exp_capita^2)" ~ "Education Exp. Squared",
    Term == "escs_mean" ~ "ESCS (Socio-Economic)",
    Term == "gini" ~ "Gini Index",
    Term == "internet" ~ "Internet Access",
    TRUE ~ Term
  )) %>%
  
  pivot_wider(
    names_from = Subject,
    values_from = c(Estimate, `Std. Error`),
    names_glue = "{Subject}_{.value}"
  ) %>%
  
  select(
    Term,
    `Mathematics_Estimate`, `Mathematics_Std. Error`,
    `Reading_Estimate`, `Reading_Std. Error`,
    `Science_Estimate`, `Science_Std. Error`
  )


kable(reg_results, 
      caption = "Regression Results - Impact of Expenditure on PISA Scores",
      align = "lcccccc",
      booktabs = TRUE,
      col.names = c("Term", "Est.", "SE", "Est.", "SE", "Est.", "SE")) %>%
  
  kable_styling(
      bootstrap_options = c("striped", "hover"), 
      full_width = F, 
      font_size = 10, 
      latex_options = c("hold_position", "scale_down")
  ) %>%
  
  add_header_above(c(" " = 1, "Mathematics" = 2, "Reading" = 2, "Science" = 2)) %>%
  footnote(general = "* p<0.1; ** p<0.05; *** p<0.01. Standard errors in parentheses.")
```

```{r}
run_clustered_ols <- function(dep_var, name) {
  
  f <- as.formula(paste(dep_var, "~ edu_exp_capita + I(edu_exp_capita^2) + escs_mean + gini + internet"))
  
  model <- lm(f, data = final_dataset)
  
  clustered_se <- coeftest(model, vcov = vcovCL(model, cluster = ~iso3c))
  
  res <- broom::tidy(model)
  
  res$std.error <- clustered_se[, 2] 
  res$p.value   <- clustered_se[, 4] 
  
  res %>%
    mutate(
      Subject = name,
      stars = case_when(
        p.value < 0.01 ~ "***",
        p.value < 0.05 ~ "**",
        p.value < 0.1  ~ "*",
        TRUE ~ ""
      ),
      estimate_str = paste0(round(estimate, 3), stars),
      std.error_str = paste0("(", round(std.error, 3), ")")
    ) %>%
    select(Term = term, Estimate = estimate_str, `Std. Error` = std.error_str, Subject)
}

res_math <- run_clustered_ols("math_mean", "Mathematics")
res_read <- run_clustered_ols("read_mean", "Reading")
res_sci  <- run_clustered_ols("science_mean", "Science")


reg_results <- bind_rows(res_math, res_read, res_sci) %>%
  
  mutate(Term = case_when(
    Term == "(Intercept)" ~ "Intercept",
    Term == "edu_exp_capita" ~ "Education Exp. (Capita)",
    Term == "I(edu_exp_capita^2)" ~ "Education Exp. Squared",
    Term == "escs_mean" ~ "ESCS (Socio-Economic)",
    Term == "gini" ~ "Gini Index",
    Term == "internet" ~ "Internet Access",
    TRUE ~ Term
  )) %>%
  
  pivot_wider(
    names_from = Subject,
    values_from = c(Estimate, `Std. Error`),
    names_glue = "{Subject}_{.value}"
  ) %>%
  
  select(
    Term,
    `Mathematics_Estimate`, `Mathematics_Std. Error`,
    `Reading_Estimate`, `Reading_Std. Error`,
    `Science_Estimate`, `Science_Std. Error`
  )

kable(reg_results, 
      caption = "Regression Results (OLS with Clustered Standard Errors)",
      align = "lcccccc",
      booktabs = TRUE,
      col.names = c("Term", "Est.", "SE", "Est.", "SE", "Est.", "SE")) %>%
  
  kable_styling(
      bootstrap_options = c("striped", "hover"), 
      full_width = F, 
      font_size = 10, 
      latex_options = c("hold_position", "scale_down")
  ) %>%
  
  add_header_above(c(" " = 1, "Mathematics" = 2, "Reading" = 2, "Science" = 2)) %>%
  footnote(general = "* p<0.1; ** p<0.05; *** p<0.01. Standard errors are clustered by country.")
```
```{r}
subgroup_analysis_data <- final_dataset %>%
  mutate(
    Income_Group = if_else(gdp_ppp < 30000, "Low/Mid Income", "High Income")
  ) %>%
  filter(
    !is.na(Income_Group),
    !is.na(edu_exp_capita),
    !is.na(escs_mean),
    !is.na(gini),
    !is.na(internet)
  )
```
```{r}

get_comparison_data <- function(dep_var) {
  
  f <- as.formula(paste(dep_var, "~ edu_exp_capita + escs_mean + gini + internet"))

  data_high <- filter(subgroup_analysis_data, Income_Group == "High Income")
  model_high <- lm(f, data = data_high)
  
  vcov_high <- vcovCL(model_high, cluster = ~iso3c, type = "HC1") 
  ct_high   <- coeftest(model_high, vcov = vcov_high)
  
  res_high <- broom::tidy(model_high) %>%
    mutate(
      estimate = ct_high[, 1], 
      std.error = ct_high[, 2], 
      p.value = ct_high[, 4],
      stars = case_when(
        p.value < 0.01 ~ "***",
        p.value < 0.05 ~ "**",
        p.value < 0.1  ~ "*",
        TRUE ~ ""
      ),
      est_str = paste0(round(estimate, 4), stars),
      se_str  = paste0("(", round(std.error, 4), ")")
    ) %>%
    select(term, High_Est = est_str, High_SE = se_str)
  
  data_low <- filter(subgroup_analysis_data, Income_Group == "Low/Mid Income")
  model_low <- lm(f, data = data_low)
  
  vcov_low <- vcovCL(model_low, cluster = ~iso3c, type = "HC1")
  ct_low   <- coeftest(model_low, vcov = vcov_low)
  
  res_low <- broom::tidy(model_low) %>%
    mutate(
      estimate = ct_low[, 1],
      std.error = ct_low[, 2],
      p.value = ct_low[, 4],
      stars = case_when(
        p.value < 0.01 ~ "***",
        p.value < 0.05 ~ "**",
        p.value < 0.1  ~ "*",
        TRUE ~ ""
      ),
      est_str = paste0(round(estimate, 4), stars),
      se_str  = paste0("(", round(std.error, 4), ")")
    ) %>%
    select(term, Low_Est = est_str, Low_SE = se_str)
  
  left_join(res_high, res_low, by = "term")
}

df_math <- get_comparison_data("math_mean")
df_read <- get_comparison_data("read_mean")
df_sci  <- get_comparison_data("science_mean")

combined_results <- bind_rows(df_math, df_read, df_sci) %>%
  mutate(term = case_when(
    term == "(Intercept)" ~ "Intercept",
    term == "edu_exp_capita" ~ "Education Exp.",
    term == "escs_mean" ~ "ESCS",
    term == "gini" ~ "Gini Index",
    term == "internet" ~ "Internet Access",
    TRUE ~ term
  ))

n_rows <- nrow(df_math)

kable(combined_results, 
      caption = "Heterogeneity Analysis: Impact of Expenditure by Income Level",
      align = "lcccc",
      booktabs = TRUE,
      col.names = c("Term", "Est.", "SE", "Est.", "SE")) %>%
  
  add_header_above(c(" " = 1, "High Income (>30k)" = 2, "Low/Mid Income (<30k)" = 2)) %>%
  
  pack_rows("Mathematics", 1, n_rows, label_row_css = "background-color: #f2f2f2; font-weight: bold;") %>%
  pack_rows("Reading", n_rows + 1, n_rows * 2, label_row_css = "background-color: #f2f2f2; font-weight: bold;") %>%
  pack_rows("Science", n_rows * 2 + 1, n_rows * 3, label_row_css = "background-color: #f2f2f2; font-weight: bold;") %>%
  
  kable_styling(
    bootstrap_options = c("hover", "condensed"), 
    full_width = F, 
    font_size = 10,
    latex_options = "hold_position"
  ) %>%
  footnote(general = "* p<0.1; ** p<0.05; *** p<0.01. Clustered SE in parentheses.")
```


```{r}
run_comparative_quantile_plot <- function(dep_var, subject_name) {
  
  get_group_results <- function(subset_data, group_label) {
    
    clean_data <- subset_data %>%
      filter(!is.na(edu_exp_capita), !is.na(gdp_ppp), 
             !is.na(escs_mean), !is.na(gini), !is.na(internet))
    
    f <- as.formula(paste(dep_var, "~ edu_exp_capita + gdp_ppp + escs_mean + gini + internet"))
    
    rq_model <- rq(f, data = clean_data, tau = seq(0.1, 0.9, 0.1))
    rq_res <- broom::tidy(rq_model, se.type = "nid", conf.int = TRUE) %>%
      filter(term == "edu_exp_capita") %>%
      mutate(Type = "Quantile Regression", Income_Group = group_label)
    
    lm_model <- lm(f, data = clean_data)
    lm_res <- broom::tidy(lm_model, conf.int = TRUE) %>%
      filter(term == "edu_exp_capita") %>%
      mutate(Type = "OLS Average", Income_Group = group_label)
    
    return(list(rq = rq_res, lm = lm_res))
  }
  
  
  data_low <- final_dataset %>% filter(gdp_ppp < 30000)
  res_low <- get_group_results(data_low, "Low/Mid Income (< $30k)")
  
  data_high <- final_dataset %>% filter(gdp_ppp >= 30000)
  res_high <- get_group_results(data_high, "High Income (>= $30k)")
  
  plot_data_rq <- bind_rows(res_low$rq, res_high$rq)
  plot_data_lm <- bind_rows(res_low$lm, res_high$lm)
  
  ggplot() +
    
    geom_rect(data = plot_data_lm, 
              aes(xmin = 0.1, xmax = 0.9, ymin = conf.low, ymax = conf.high),
              fill = "#E64B35", alpha = 0.15) + 
    geom_hline(data = plot_data_lm, aes(yintercept = estimate), 
               color = "#E64B35", linetype = "longdash", linewidth = 0.8) +
    
    geom_ribbon(data = plot_data_rq, 
                aes(x = tau, ymin = conf.low, ymax = conf.high),
                fill = "#4DBBD5", alpha = 0.25) + 
    geom_line(data = plot_data_rq, aes(x = tau, y = estimate), 
              color = "#3C5488", linewidth = 1) + 
    geom_point(data = plot_data_rq, aes(x = tau, y = estimate), 
               color = "#3C5488", size = 2) +
    
    geom_hline(yintercept = 0, color = "grey40", linetype = "dotted") +
    
    facet_wrap(~Income_Group, scales = "fixed") + 
    
    labs(title = paste("Comparative Analysis:", subject_name),
         subtitle = "Effect of Education Expenditure across Student Performance Distribution",
         x = "Quantile (Tau) \n(Left: Low Achievers -> Right: High Achievers)",
         y = "Coefficient of Expenditure") +
    
    theme_bw() + 
    theme(
      plot.title = element_text(face = "bold", size = 14),
      plot.subtitle = element_text(color = "grey30", size = 10),
      strip.background = element_rect(fill = "#f0f0f0", color = NA), 
      strip.text = element_text(face = "bold", size = 11),
      axis.title = element_text(face = "bold", size = 10),
      panel.grid.minor = element_blank(), 
      panel.grid.major.x = element_blank() 
    )
}

p_comp_math <- run_comparative_quantile_plot("math_mean", "Mathematics")
p_comp_sci  <- run_comparative_quantile_plot("science_mean", "Science")
p_comp_read <- run_comparative_quantile_plot("read_mean", "Reading")

p_comp_math
p_comp_sci
p_comp_read
```


### Gender Analysis
```{r}
gender_analysis_data <- final_dataset %>%
  select(iso3c, year, country, 
         edu_exp_capita, gdp_ppp, 
         math_female, math_male,   
         read_female, read_male,   
         science_female, science_male) %>% 
  
  mutate(
    Income_Group = if_else(gdp_ppp < 30000, "Low/Mid Income", "High Income")
  ) %>%
  
  pivot_longer(
    cols = c(starts_with("math_"), starts_with("read_"), starts_with("science_")),
    names_to = c("Subject", "Gender"),
    names_sep = "_", 
    values_to = "Score"
  ) %>%
  
  mutate(Gender = str_to_title(Gender))

```
```{r}
gender_analysis_data %>%
  filter(Subject == "math") %>% 
  filter(!is.na(Score), !is.na(edu_exp_capita)) %>%
  
  ggplot(aes(x = edu_exp_capita, y = Score, color = Gender)) +
  
  geom_point(alpha = 0.3, size = 1.5) +
  
  geom_smooth(method = "lm", se = FALSE, size = 1.2) +
  
  facet_wrap(~Income_Group, scales = "free_x") +
  
  scale_color_manual(values = c("Female" = "#E41A1C", "Male" = "#377EB8")) +
  labs(
    title = "Does Money Help Boys and Girls Equally?",
    subtitle = "Impact of Education Expenditure on Math Scores by Gender and Income Level",
    x = "Education Expenditure per Capita (PPP)",
    y = "PISA Math Score"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```
```{r}
gender_analysis_data %>%
  filter(Subject == "read") %>% 
  filter(!is.na(Score), !is.na(edu_exp_capita)) %>%
  
  ggplot(aes(x = edu_exp_capita, y = Score, color = Gender)) +
  
  geom_point(alpha = 0.3, size = 1.5) +
  
  geom_smooth(method = "lm", se = FALSE, size = 1.2) +
  
  facet_wrap(~Income_Group, scales = "free_x") +
  
  scale_color_manual(values = c("Female" = "#E41A1C", "Male" = "#377EB8")) +
  labs(
    title = "Does Money Help Boys and Girls Equally?",
    subtitle = "Impact of Education Expenditure on Math Scores by Gender and Income Level",
    x = "Education Expenditure per Capita (PPP)",
    y = "PISA Read Score"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
gender_analysis_data %>%
  filter(Subject == "science") %>% 
  filter(!is.na(Score), !is.na(edu_exp_capita)) %>%
  
  ggplot(aes(x = edu_exp_capita, y = Score, color = Gender)) +
  
  geom_point(alpha = 0.3, size = 1.5) +
  
  geom_smooth(method = "lm", se = FALSE, size = 1.2) +
  
  facet_wrap(~Income_Group, scales = "free_x") +
  
  scale_color_manual(values = c("Female" = "#E41A1C", "Male" = "#377EB8")) +
  labs(
    title = "Does Money Help Boys and Girls Equally?",
    subtitle = "Impact of Education Expenditure on Math Scores by Gender and Income Level",
    x = "Education Expenditure per Capita (PPP)",
    y = "PISA Science Score"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

### Cluster

```{r}
cluster_data_prep <- final_dataset %>%
  group_by(iso3c) %>%
  summarise(
    math_avg = mean(math_mean, na.rm = TRUE),
    read_avg = mean(read_mean, na.rm = TRUE),
    sci_avg  = mean(science_mean, na.rm = TRUE),
    avg_exp  = mean(as.numeric(edu_exp_capita), na.rm = TRUE),
    avg_gdp  = mean(as.numeric(gdp_ppp), na.rm = TRUE)
  ) %>%
  mutate(
    avg_score = (math_avg + read_avg + sci_avg) / 3
  ) %>%
  
  select(iso3c, avg_score, avg_exp, avg_gdp) %>% 
  column_to_rownames("iso3c") %>%
  na.omit()

df_scaled <- scale(cluster_data_prep)

fviz_nbclust(df_scaled, kmeans, method = "wss", k.max = 10) +
  geom_vline(xintercept = 4, linetype = 2) + 
  labs(subtitle = "Elbow Method (Revised with Overall Scores)") +
  theme_minimal()
```
```{r}
set.seed(123)
km_res <- kmeans(df_scaled, centers = 4, nstart = 25)

pca_res <- prcomp(df_scaled, scale. = FALSE) 

plot_data <- as.data.frame(pca_res$x) %>% 
  select(PC1, PC2) %>% 
  mutate(
    Cluster = as.factor(km_res$cluster),
    Country = rownames(.)
  )

hull_data <- plot_data %>%
  group_by(Cluster) %>%
  slice(chull(PC1, PC2))

ggplot(plot_data, aes(x = PC1, y = PC2)) +
  
  geom_polygon(data = hull_data, aes(fill = Cluster), alpha = 0.2) +
  
  geom_text(aes(label = Country, color = Cluster), size = 3.5, fontface = "bold") +
  
  scale_color_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2") +
  
  theme_minimal() +
  labs(
    title = "Cluster Analysis: Typologies of Education Systems",
    subtitle = "Based on: Overall Score (Math+Read+Sci), Expenditure & GDP",
    x = paste0("Dim1 (", round(summary(pca_res)$importance[2,1]*100, 1), "%)"),
    y = paste0("Dim2 (", round(summary(pca_res)$importance[2,2]*100, 1), "%)")
  ) +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "right"
  )
```
## Conclusion


